import{f as O,s as x,h as Y,b as Be,c as v,g as X,a as ye,e as V,d as Ae}from"./utils-eOyd3SEQ.js";let y=[],p="",N=null,d=[],h=[],T=null;const De="https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",ne=document.getElementById("pdfUpload"),q=document.getElementById("pdfRawTextPreview"),oe=document.getElementById("processPdfButton"),ae=document.getElementById("supplierName"),re=document.getElementById("documentDate"),se=document.getElementById("documentNumber"),le=document.getElementById("totalAmount"),G=document.getElementById("configName"),_=document.getElementById("officialSupplierNameForExportInput"),U=document.getElementById("supplierNameRegex"),A=document.getElementById("documentDateRegex"),D=document.getElementById("documentNumberRegex"),L=document.getElementById("totalAmountRegex"),b=document.getElementById("configSelect"),W=document.getElementById("previewButton"),B=document.getElementById("dropArea"),ue=document.getElementById("uploadedFilesList");document.getElementById("allExtractedResultsContainer");const j=document.getElementById("extractedResultsTableBody"),ve=document.getElementById("downloadCsvButton"),Le=document.getElementById("clearUploadFormButton"),ee=document.getElementById("currentAnalysisFileName"),k=document.getElementById("tabButtonProcess"),$=document.getElementById("tabButtonTemplate"),me=document.getElementById("tabContentProcess"),ge=document.getElementById("tabContentTemplate"),Pe=document.getElementById("aiSuggestDateBtn"),Re=document.getElementById("aiSuggestNumberBtn"),Fe=document.getElementById("aiSuggestAmountBtn");document.getElementById("confirmationModal");document.getElementById("confirmationModalTitle");document.getElementById("confirmationModalText");document.getElementById("confirmActionButton");document.getElementById("cancelConfirmationButton");const he=document.getElementById("regexSuggestModal"),ke=document.getElementById("regexSuggestModalTitle"),be=document.getElementById("regexUserPrompt"),z=document.getElementById("generateRegexButton"),w=document.getElementById("regexSuggestionsContainer");document.getElementById("noSuggestionsText");const C=document.getElementById("regexSuggestStatus"),$e=document.getElementById("cancelRegexSuggestButton"),H=document.getElementById("useSelectedRegexButton"),I=document.getElementById("regexTestResult"),ie=document.getElementById("saveTemplateButton"),ce=document.getElementById("deleteTemplateButton"),Ee=document.getElementById("importConfigButton"),Ne=document.getElementById("exportAllConfigsButton"),pe=document.getElementById("upload-label-invoice"),fe=document.getElementById("file-info-invoice");function F(){v("No Document Selected","Please select a document from the 'Extract' tab first to proceed.","OK",()=>{},()=>{})}function Q(e){T=e,ke.textContent=`AI Regex Suggestions for ${e.replace(/([A-Z])/g," $1").toLowerCase().replace("document ","")}`,be.value="",w.innerHTML='<p id="noSuggestionsText" class="text-sm p-secondary">Click "Generate Suggestions" to get AI help.</p>',H.disabled=!0,C.textContent="",I.textContent="Test Result: No regex tested yet.",he.showModal()}function Se(){he.close(),T=null}function Me(e){if(!p){I.textContent="Test Result: Error - No PDF text loaded for analysis.",I.classList.add("text-red-500");return}I.classList.remove("text-red-500","text-green-500");try{const t=new RegExp(e,"i"),n=p.match(t);if(n){const o=n[1]?n[1].trim():n[0].trim();let s=o;T==="documentNumber"&&(s=o.replace(/\s*-\s*/g,"-").replace(/\s+/g,"").trim()),I.textContent=`Test Result: Match Found -> "${s}"`,I.classList.add("text-green-500")}else I.textContent="Test Result: No match found.",I.classList.add("text-red-500")}catch(t){I.textContent=`Test Result: Invalid regex pattern -> ${t.message}`,I.classList.add("text-red-500")}}function Oe(){const e=w.querySelector('input[name="regexSuggestion"]:checked');if(e){const t=decodeURIComponent(e.value);T==="documentDate"?A.value=t:T==="documentNumber"?D.value=t:T==="totalAmount"&&(L.value=t),Se(),W.click()}else v("Selection Required","Please select a regex suggestion first.","OK",()=>{},()=>{})}async function te(e,t=null,n=!1,o=!1,s=!0,r=null,a=null){let i=X();if(s&&!i)try{const c=await ye();if(!c)return v("API Key Required","Gemini API key is required for AI-powered features. Operation canceled.","OK",()=>{},()=>{}),null;i=c}catch{return v("API Key Error","Could not get Gemini API key. Operation canceled.","OK",()=>{},()=>{}),null}oe.disabled=!0,W.disabled=!0,ie.disabled=!0,ce.disabled=!0,Ee.disabled=!0,Ne.disabled=!0,document.querySelectorAll(".ai-suggest-button").forEach(c=>{c.disabled=!0});let l,m="application/json",g={};if(o&&d.length>0)return g=Ie(e,d),g;if(r){C.textContent="Generating suggestions...";let c=`From the following document text, suggest 3-5 JavaScript-compatible regular expressions (regex) to extract the "${r}" field. Provide only the regex patterns, in a JSON array format like {"regexSuggestions": ["regex1", "regex2", "regex3"]}. The regex should include a capturing group for the value if applicable, and be suitable for use with JavaScript's String.prototype.match() method.`;a&&(c+=`

Additional context from user: "${a}"`),l=`${c}
Document Text: "${e.substring(0,Math.min(e.length,1500))}"`,m="application/json"}else if(s)l=`Extract the following information from the invoice/receipt text:
`,l+=`- Supplier Name
- Document Date
- Document Number
- Total Amount

`,l+=`Return the results in a JSON object with keys: "supplierName", "documentDate", "documentNumber", "totalAmount".
`,l+=`If a value is not found, return null for that key. Ensure Total Amount is a number (e.g., 123.45). Date should be in DD/MM/YYYY format.

`,t&&(l+=`Here are some extraction guidelines. For each field, **strictly attempt to extract using the provided pattern first.** If the pattern does not yield a result, or if no pattern is provided, then use general knowledge to find the best match:
`,t.supplierNamePattern&&(l+=`- Supplier Name Regex: "${t.supplierNamePattern}"
`),t.documentDatePattern&&(l+=`- Document Date Regex: "${t.documentDatePattern}"
`),t.documentNumberPattern&&(l+=`- Document Number Regex: "${t.documentNumberPattern}"
`),t.totalAmountPattern&&(l+=`- Total Amount Regex: "${t.totalAmountPattern}"
`),l+=`
`),l+=`Invoice/Receipt Text:

${e}

JSON Output:`;else return g=Ue(e,t),g;try{const c=await fetch(`${De}?key=${i}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:l}]}],generationConfig:{responseMimeType:m}})});if(!c.ok){const R=await c.json();throw new Error(`API call failed: ${R.error.message||c.statusText}`)}const E=await c.json();if(!E.candidates||!E.candidates.length||!E.candidates[0].content||!E.candidates[0].content.parts||!E.candidates[0].content.parts.length||!E.candidates[0].content.parts[0].text)throw new Error("Invalid response format from Gemini API.");const f=JSON.parse(E.candidates[0].content.parts[0].text);return r?f&&Array.isArray(f.regexSuggestions)?(C.textContent="Suggestions generated. Select one to use.",f.regexSuggestions):(C.textContent="No regex suggestions could be generated.",[]):(Array.isArray(f)&&f.length>0?g=f[0]:typeof f=="object"&&f!==null&&(g=f),g)}catch(c){throw x("error",`AI operation failed: ${c.message}`),C.textContent=`Error: ${c.message}`,c}finally{u(),S()}}function Ue(e,t){const n={supplierName:null,documentDate:null,documentNumber:null,totalAmount:null},o=(s,r)=>{if(!r)return null;try{const a=new RegExp(r,"i"),i=s.match(a);return i?i[1]?i[1].trim():i[0].trim():null}catch{return null}};if(t){n.supplierName=o(e,t.supplierNamePattern);let s=o(e,t.documentDatePattern);n.documentDate=s;let r=o(e,t.documentNumberPattern);r&&(r=r.replace(/\s*-\s*/g,"-").replace(/\s+/g,"").trim()),n.documentNumber=r;const a=o(e,t.totalAmountPattern);if(a){const i=a.replace(/[^0-9.]/g,""),l=parseFloat(i);isNaN(l)||(n.totalAmount=l)}}return n}function Ie(e,t){let n=[];const o=(r,a)=>{if(!a)return!1;try{return new RegExp(a,"i").test(r)}catch{return!1}};for(const r of t){let a=0;o(e,r.supplierNamePattern)&&(a+=4),o(e,r.documentNumberPattern)&&(a+=3),o(e,r.totalAmountPattern)&&(a+=2),o(e,r.documentDatePattern)&&(a+=1),a>0&&n.push({configName:r.name,score:a})}if(n.length===0)return{matchedConfigName:"None"};n.sort((r,a)=>a.score-r.score);const s=n[0];return s.score>=3?{matchedConfigName:s.configName}:{matchedConfigName:"None"}}async function je(){if(!p){v("Missing PDF","A PDF must be loaded for analysis to generate regex suggestions.","OK",()=>{},()=>{});return}if(!X()&&(await ye(),!X())){v("API Key Required","Gemini API key is required for AI-powered features. Operation canceled.","OK",()=>{},()=>{}),z.disabled=!1,u();return}const e=be.value.trim();C.textContent="Generating suggestions...",z.disabled=!0,H.disabled=!0,w.innerHTML='<p class="text-center"><span class="loading loading-spinner loading-md"></span> Generating...</p>';try{const t=await te(p,null,!1,!1,!0,T,e);w.innerHTML="",t&&t.length>0?(t.forEach((n,o)=>{const s=document.createElement("div");s.className="flex items-center mb-2",s.innerHTML=`
                    <input type="radio" name="regexSuggestion" id="regex-${o}" value="${encodeURIComponent(n)}" class="mr-2">
                    <label for="regex-${o}" class="text-sm font-mono bg-base-100 p-1 rounded cursor-pointer flex-1 break-all">${n}</label>
                `,w.appendChild(s)}),H.disabled=!1,C.textContent="Suggestions generated. Select one to use.",w.addEventListener("change",Ye)):(w.innerHTML='<p class="text-sm text-error">No regex suggestions could be generated. Try a different prompt.</p>',C.textContent="No suggestions.")}catch{w.innerHTML='<p class="text-sm text-error">Failed to get suggestions. Check console for details.</p>',C.textContent="Error generating suggestions."}finally{z.disabled=!1}}const J="invoiceTemplates";function He(){const e=localStorage.getItem(J);try{d=e?JSON.parse(e):[]}catch{d=[]}return P(),d}function Je(){const e=G.value.trim();if(!e){v("Missing Template Name","Please enter a template name to save the configuration.","OK",()=>{},()=>{});return}const t={name:e,officialSupplierNameForExport:_.value.trim(),supplierNamePattern:U.value,documentDatePattern:A.value,documentNumberPattern:D.value,totalAmountPattern:L.value},n=d.findIndex(o=>o.name===e);n!==-1?v("Overwrite Template?",`A template named "${e}" already exists. Do you want to overwrite it?`,"Overwrite",()=>{d[n]=t,localStorage.setItem(J,JSON.stringify(d)),P(),x("success","Template updated successfully.")},()=>{}):(d.push(t),localStorage.setItem(J,JSON.stringify(d)),P(),x("success","Template saved successfully.")),u()}function Ke(){const e=b.value;if(!e){v("No Template Selected","Please select a template to delete.","OK",()=>{},()=>{});return}v("Confirm Deletion",`Are you sure you want to delete the template "${e}"? This action cannot be undone.`,"Delete",()=>{d=d.filter(t=>t.name!==e),localStorage.setItem(J,JSON.stringify(d)),K(),P(),x("success","Template deleted successfully.")},()=>{}),u()}function P(){if(b.innerHTML='<option value="">-- Select a template --</option>',d.length===0){b.innerHTML='<option value="">-- No templates available --</option>';return}d.forEach(e=>{const t=document.createElement("option");t.value=e.name,t.textContent=e.name,b.appendChild(t)})}function Ge(){if(d.length===0){v("No Data to Export","There are no saved templates to export.","OK",()=>{},()=>{});return}const e=JSON.stringify(d,null,2),t=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download=`invoice-templates-backup-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),x("success","All templates exported successfully.")}function qe(){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=t=>{const n=t.target.files[0];if(!n)return;const o=new FileReader;o.onload=s=>{try{const r=JSON.parse(s.target.result);if(!Array.isArray(r))throw new Error("Invalid JSON format. Expected an array of templates.");let a=0,i=0;r.forEach(l=>{if(!l.name)return;const m=d.findIndex(g=>g.name===l.name);m!==-1?(d[m]=l,i++):(d.push(l),a++)}),localStorage.setItem(J,JSON.stringify(d)),P(),x("success",`Successfully imported ${a} new templates and updated ${i} existing templates.`)}catch(r){x("error","Failed to import configurations: "+r.message)}},o.readAsText(n)},e.click()}function xe(e){const t=Array.from(e).filter(n=>n.type==="application/pdf");if(t.length===0){y.length===0&&x("error","Please select valid PDF file(s)."),S();return}t.forEach(n=>{y.some(o=>o.name===n.name&&o.size===n.size)||y.push(n)}),Z(),Y()}function ze(e){y.splice(e,1);const t=new DataTransfer;y.forEach(n=>t.items.add(n)),ne.files=t.files,Z(),y.length===0&&(Y(),de())}async function Ce(e){if(!e||e.type!=="application/pdf"){q.value="",ee.textContent="-",p="";return}ee.textContent=e.name;const t=new FileReader;t.onload=async n=>{const o=new Uint8Array(n.target.result);try{const s=await pdfjsLib.getDocument({data:o}).promise;let r="";for(let a=1;a<=s.numPages;a++){const l=await(await s.getPage(a)).getTextContent();r+=l.items.map(m=>m.str).join(" ")+`
`}p=r,q.value=r}catch(s){q.value="",v("PDF Text Extraction Error","Error extracting text from PDF: "+s.message,"OK",()=>{},()=>{}),p=""}finally{u()}},t.readAsArrayBuffer(e)}function we(){const e=b.value;if(e===""){K();return}const t=d.find(n=>n.name===e);t?(N=t,G.value=N.name||"",_.value=N.officialSupplierNameForExport||"",U.value=N.supplierNamePattern||"",A.value=N.documentDatePattern||"",D.value=N.documentNumberPattern||"",L.value=N.totalAmountPattern||""):(v("Template Not Found","Selected template not found in local storage.","OK",()=>{},()=>{}),N=null),u(),S()}function Ye(e){if(e.target.name==="regexSuggestion"&&e.target.checked){const t=decodeURIComponent(e.target.value);Me(t),H.disabled=!1}}function Z(){ue.innerHTML="",y.length===0?(fe.classList.add("hidden"),pe.classList.remove("hidden"),Y()):(fe.classList.remove("hidden"),pe.classList.add("hidden"),y.forEach((e,t)=>{const n=document.createElement("span");n.className="badge badge-md badge-info mr-2 mb-2",n.innerHTML=`
        ${e.name}
        <button type="button" class="ml-2" data-index="${t}">
          <svg class="h-3 w-3" stroke="currentColor" fill="none" viewBox="0 0 8 8">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M1 1l6 6m0-6L1 7" />
          </svg>
        </button>
      `,n.querySelector("button").addEventListener("click",o=>{const s=parseInt(o.currentTarget.dataset.index);ze(s)}),ue.appendChild(n)}),Y()),S()}function Ve(e,t){const n=j,o=n.querySelector('tr td[colspan="7"]');o&&o.parentElement.remove();const s=n.insertRow();s.setAttribute("data-index",t),s.className="table-row-base",s.innerHTML=`
      <td class="text-sm break-words max-w-[150px] overflow-hidden">${e.fileName}</td>
      <td class="text-xs">${e.configUsedName||"-"}</td>
      <td class="text-sm">${e.officialSupplierNameForExport||e.extractedSupplierName||"-"}</td>
      <td class="text-sm">${O(e.documentDate)}</td>
      <td class="text-sm">${e.documentNumber||"-"}</td>
      <td class="text-sm">${V(e.totalAmount)}</td>
      <td>
          <button data-index="${t}" class="analyze-row-button btn btn-info btn-sm flex items-center justify-center">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </button>
      </td>
  `,s.querySelector(".analyze-row-button").addEventListener("click",async r=>{const a=parseInt(r.target.closest("button").dataset.index),i=h[a],l=h[a].originalFile;if(M("Template"),await Ce(l),ae.textContent=i.extractedSupplierName||"-",re.textContent=O(i.documentDate),se.textContent=i.documentNumber||"-",le.textContent=V(i.totalAmount),i.configUsedName&&i.configUsedName!=="-"){const m=d.find(g=>g.name===i.configUsedName);m?(b.value=m.name,we()):(b.value="",N=null,K())}else b.value="",N=null,K();u()})}function _e(){j.innerHTML="",h.length===0?j.innerHTML='<tr><td colspan="7" class="text-center">No documents processed yet.</td></tr>':h.forEach((e,t)=>{Ve(e,t)})}function We(){if(h.length===0){x("info","No data to export to CSV.");return}const e=["Supplier Name","Document Date","Document Number","Total Amount"],t=h.map(n=>{const o=O(n.documentDate),s=V(n.totalAmount)||"";return{"Supplier Name":n.officialSupplierNameForExport||n.extractedSupplierName,"Document Date":o,"Document Number":n.documentNumber,"Total Amount":s}});Ae(t,e,"invoices.csv")}function K(){G.value="",_.value="",U.value="",A.value="",D.value="",L.value="",N=null,b.value="",u()}function de(){ae.textContent="-",re.textContent="-",se.textContent="-",le.textContent="-",ee.textContent="-",p="",q.value="",u()}function Te(){h=[],j.innerHTML='<tr><td colspan="7" class="text-center">No documents processed yet.</td></tr>',S()}function Ze(){y=[],ne.value="",Z(),p="",de(),K(),P(),Be(),Te(),M("Process"),u(),S()}function S(){const e=y.length>0,t=h.length>0;oe.disabled=!e,ve.disabled=!t}function u(){const e=p.length>0,t=G.value.trim().length>0,n=b.value!=="";W.disabled=!e,ie.disabled=!t,ce.disabled=!n,document.querySelectorAll(".ai-suggest-button").forEach(o=>{o.disabled=!e})}function M(e){e==="Process"?(k.classList.add("tab-active"),k.classList.remove("tab-button-inactive"),$.classList.add("tab-button-inactive"),$.classList.remove("tab-active"),me.classList.remove("hidden"),ge.classList.add("hidden"),S()):e==="Template"&&($.classList.add("tab-active"),$.classList.remove("tab-button-inactive"),k.classList.add("tab-button-inactive"),k.classList.remove("tab-active"),ge.classList.remove("hidden"),me.classList.add("hidden"),u(),de(),!p&&y.length>0&&Ce(y[0]))}document.addEventListener("DOMContentLoaded",async()=>{M("Process"),Z(),u(),S(),He(),k.addEventListener("click",()=>M("Process")),$.addEventListener("click",()=>M("Template")),ne.addEventListener("change",e=>xe(e.target.files)),Le.addEventListener("click",Ze),B.addEventListener("dragover",e=>{e.preventDefault(),B.classList.add("border-primary","bg-primary","bg-opacity-10")}),B.addEventListener("dragleave",()=>{B.classList.remove("border-primary","bg-primary","bg-opacity-10")}),B.addEventListener("drop",e=>{e.preventDefault(),B.classList.remove("border-primary","bg-primary","bg-opacity-10"),xe(e.dataTransfer.files)}),oe.addEventListener("click",async()=>{if(y.length===0){F();return}Te(),j.innerHTML='<tr><td colspan="7" class="text-center">Processing...</td></tr>',S();let e=0;for(let t=0;t<y.length;t++){const n=y[t];if(n.type!=="application/pdf")continue;const o=new FileReader,s=new Promise((r,a)=>{o.onload=async i=>{const l=new Uint8Array(i.target.result);try{const m=await pdfjsLib.getDocument({data:l}).promise;let g="";for(let c=1;c<=m.numPages;c++){const f=await(await m.getPage(c)).getTextContent();g+=f.items.map(R=>R.str).join(" ")+`
`}r(g)}catch(m){a(`Error extracting text from PDF "${n.name}": ${m.message}`)}},o.onerror=i=>a(`FileReader error for "${n.name}": ${i}`),o.readAsArrayBuffer(n)});try{const r=await s;let a,i="-",l=null,m=null;if(d.length>0){const c=Ie(r,d);if(c&&c.matchedConfigName&&c.matchedConfigName!=="-"){const E=c.matchedConfigName,f=d.find(R=>R.name===E);f&&(l=f,i=E,m=f.officialSupplierNameForExport||null)}}`${n.name}${l?l.name:"None"}`,a=await te(r,l,!1,!1,!1);const g={originalFile:n,fileName:n.name,configUsedName:i,extractedSupplierName:a.supplierName||"-",officialSupplierNameForExport:m,documentDate:a.documentDate?O(a.documentDate):"-",documentNumber:a.documentNumber||"-",totalAmount:a.totalAmount||null};h.push(g)}catch(r){const a={originalFile:n,fileName:n.name,configUsedName:"Error",extractedSupplierName:"Error",officialSupplierNameForExport:"Error",documentDate:"Error",documentNumber:"Error",totalAmount:null,error:r.message};h.push(a),x("error",`Error processing file "${n.name}": ${r.message}`)}e++}h.sort((t,n)=>{const o=new Date(t.documentDate.split("/").reverse().join("-")),s=new Date(n.documentDate.split("/").reverse().join("-"));return isNaN(o.getTime())&&isNaN(s.getTime())?0:isNaN(o.getTime())?1:isNaN(s.getTime())?-1:o.getTime()-s.getTime()}),_e(),h.length>0?x("success",`Finished processing ${e} PDF(s). Data ready for download.`):x("warning",`Finished processing ${e} PDF(s), but no data was extracted.`),S()}),W.addEventListener("click",async()=>{if(!p){F();return}try{const e={supplierNamePattern:U.value,documentDatePattern:A.value,documentNumberPattern:D.value,totalAmountPattern:L.value},t=await te(p,e,!0,!1,!1);t?(ae.textContent=t.supplierName||"-",re.textContent=O(t.documentDate),se.textContent=t.documentNumber||"-",le.textContent=V(t.totalAmount),x("success","Preview complete!")):x("warning","No refined data extracted during preview.")}catch(e){x("error",`Error during preview: ${e.message}. Check console for details.`)}finally{u(),S()}}),Pe.addEventListener("click",()=>{p?Q("documentDate"):F()}),Re.addEventListener("click",()=>{p?Q("documentNumber"):F()}),Fe.addEventListener("click",()=>{p?Q("totalAmount"):F()}),z.addEventListener("click",je),$e.addEventListener("click",Se),H.addEventListener("click",Oe),ie.addEventListener("click",Je),ce.addEventListener("click",Ke),Ee.addEventListener("click",qe),Ne.addEventListener("click",Ge),b.addEventListener("change",we),ve.addEventListener("click",We),b.addEventListener("change",()=>{u()}),G.addEventListener("input",u),_.addEventListener("input",u),U.addEventListener("input",u),A.addEventListener("input",u),D.addEventListener("input",u),L.addEventListener("input",u)});
