import{c as ee,b as be,e as Re,i as ge,j as $,s as i,h as K,f as ke,k as Fe,g as _,a as ie,l as he,m as V,d as Me,r as $e}from"./navigation-CxuvExTJ.js";let g=[],p="",x=null,l=[],y=[],S=null;const Oe="https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",le=document.getElementById("file-input"),z=document.getElementById("pdfRawTextPreview"),te=document.getElementById("process-btn"),ne=document.getElementById("process-btn-text"),oe=document.getElementById("spinner-process"),ce=document.getElementById("supplierName"),de=document.getElementById("documentDate"),ue=document.getElementById("documentNumber"),me=document.getElementById("totalAmount"),J=document.getElementById("configName"),Y=document.getElementById("officialSupplierNameForExportInput"),O=document.getElementById("supplierNameRegex"),B=document.getElementById("documentDateRegex"),T=document.getElementById("documentNumberRegex"),P=document.getElementById("totalAmountRegex"),f=document.getElementById("configSelect"),W=document.getElementById("previewButton"),ae=document.getElementById("preview-btn-text"),se=document.getElementById("spinner-preview"),L=document.getElementById("upload-area"),pe=document.getElementById("file-pills-container");document.getElementById("results-container");const j=document.getElementById("results-table-body"),Ne=document.getElementById("download-btn"),je=document.getElementById("remove-all-files-btn"),re=document.getElementById("currentAnalysisFileName"),k=document.getElementById("tabButtonProcess"),F=document.getElementById("tabButtonTemplate"),fe=document.getElementById("tabContentProcess"),xe=document.getElementById("tabContentTemplate"),Ue=document.getElementById("aiSuggestDateBtn"),He=document.getElementById("aiSuggestNumberBtn"),Je=document.getElementById("aiSuggestAmountBtn");document.getElementById("confirmationModal");document.getElementById("confirmationModalTitle");document.getElementById("confirmationModalText");document.getElementById("confirmActionButton");document.getElementById("cancelConfirmationButton");const Ie=document.getElementById("regexSuggestModal"),Ge=document.getElementById("regexSuggestModalTitle"),we=document.getElementById("regexUserPrompt"),I=document.getElementById("generateRegexButton"),h=document.getElementById("regexSuggestionsContainer");document.getElementById("noSuggestionsText");const N=document.getElementById("regexSuggestStatus"),qe=document.getElementById("cancelRegexSuggestButton"),A=document.getElementById("useSelectedRegexButton"),E=document.getElementById("regexTestResult"),Se=document.getElementById("saveTemplateButton"),Ce=document.getElementById("deleteTemplateButton"),ze=document.getElementById("importConfigButton"),Ke=document.getElementById("exportAllConfigsButton"),ye=document.getElementById("upload-label"),ve=document.getElementById("file-info");async function X(e){if(!p){ee();return}if(!_()&&!await ie()){i("error","Gemini API key is required for AI-powered features. Operation canceled.");return}S=e,Ge.textContent=`AI Regex Suggestions for ${e.replace(/([A-Z])/g," $1").toLowerCase().replace("document ","")}`,we.value="",h.innerHTML='<p id="noSuggestionsText" class="text-sm p-secondary">Click "Generate Suggestions" to get AI help.</p>',A.disabled=!0,N.textContent="",E.textContent="Test Result: No regex tested yet.",Ie.showModal()}function Le(){Ie.close(),S=null}function _e(e){if(!p){E.textContent="Test Result: Error - No PDF text loaded for analysis.",E.classList.add("text-red-500");return}E.classList.remove("text-red-500","text-green-500");try{const t=new RegExp(e,"i"),n=p.match(t);if(n){const o=n[1]?n[1].trim():n[0].trim();let a=o;S==="documentNumber"&&(a=o.replace(/\s*-\s*/g,"-").replace(/\s+/g,"").trim()),E.textContent=`Test Result: Match Found -> "${a}"`,E.classList.add("text-green-500")}else E.textContent="Test Result: No match found.",E.classList.add("text-red-500")}catch(t){E.textContent=`Test Result: Invalid regex pattern -> ${t.message}`,E.classList.add("text-red-500")}}function Ve(){const e=h.querySelector('input[name="regexSuggestion"]:checked');if(e){const t=decodeURIComponent(e.value);S==="documentDate"?B.value=t:S==="documentNumber"?T.value=t:S==="totalAmount"&&(P.value=t),Le(),W.click()}else i("info","Please select a regex suggestion first.")}async function We(e,t,n){let o=_();if(!o)try{const r=await ie();if(!r)return i("error","Gemini API key is required for AI-powered features. Operation canceled."),[];o=r}catch{return i("error","Could not get Gemini API key. Operation canceled."),[]}I.disabled=!0,A.disabled=!0,N.textContent="Generating suggestions...",h.innerHTML='<p class="text-center">Generating <span class="loading loading-spinner loading-md"></span></p>';let a=`From the following document text, suggest 3-5 JavaScript-compatible regular expressions (regex) to extract the "${t}" field. Provide only the regex patterns, in a JSON array format like {"regexSuggestions": ["regex1", "regex2", "regex3"]}. The regex should include a capturing group for the value if applicable, and be suitable for use with JavaScript's String.prototype.match() method.`;n&&(a+=`

Additional context from user: "${n}"`);const u=`${a}
Document Text: "${e.substring(0,Math.min(e.length,1500))}"`;try{const r=await fetch(`${Oe}?key=${o}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:u}]}],generationConfig:{responseMimeType:"application/json"}})});if(!r.ok){const m=await r.json();throw new Error(`API call failed: ${m.error.message||r.statusText}`)}const s=await r.json();if(!s.candidates||!s.candidates.length||!s.candidates[0].content||!s.candidates[0].content.parts||!s.candidates[0].content.parts.length||!s.candidates[0].content.parts[0].text)throw new Error("Invalid response format from Gemini API.");const c=JSON.parse(s.candidates[0].content.parts[0].text);return c&&Array.isArray(c.regexSuggestions)?(N.textContent="Suggestions generated. Select one to use.",c.regexSuggestions):(N.textContent="No regex suggestions could be generated.",[])}catch(r){return i("error",`AI operation failed: ${r.message}`),N.textContent=`Error: ${r.message}`,[]}finally{I.disabled=!1,d()}}async function Ye(){if(I.disabled)return;if(I.disabled=!0,A.disabled=!0,!p){i("info","A PDF must be loaded for analysis to generate regex suggestions."),I.disabled=!1,d();return}if(!_()&&(await ie(),!_())){i("error","Gemini API key is required for AI-powered features. Operation canceled."),I.disabled=!1,d();return}const e=we.value.trim();N.textContent="Generating suggestions...",h.innerHTML='<p class="text-center">Generating <span class="loading loading-spinner loading-md"></span></p>';try{const t=await We(p,S,e);h.innerHTML="",t&&t.length>0?(t.forEach((n,o)=>{const a=document.createElement("div");a.className="flex items-center mb-2",a.innerHTML=`
                    <input type="radio" name="regexSuggestion" id="regex-${o}" value="${encodeURIComponent(n)}" class="mr-2">
                    <label for="regex-${o}" class="text-sm font-mono bg-base-100 p-1 rounded cursor-pointer flex-1 break-all">${n}</label>
                `,h.appendChild(a)}),A.disabled=!1,N.textContent="Suggestions generated. Select one to use.",h.addEventListener("change",ot)):(h.innerHTML='<p class="text-sm text-error">No regex suggestions could be generated. Try a different prompt.</p>',N.textContent="No suggestions.")}catch{h.innerHTML='<p class="text-sm text-error">Failed to get suggestions. Check console for details.</p>',N.textContent="Error generating suggestions."}finally{I.disabled=!1,d()}}const U="invoiceTemplates";function Ze(){const e=localStorage.getItem(U);try{l=e?JSON.parse(e):[]}catch(t){console.error("Error parsing local configurations:",t),l=[]}return D(),l}function Qe(){const e=J.value.trim();if(!e){i("error","Please enter a template name to save the configuration.");return}const t={name:e,officialSupplierNameForExport:Y.value.trim(),supplierNamePattern:O.value,documentDatePattern:B.value,documentNumberPattern:T.value,totalAmountPattern:P.value},n=l.findIndex(o=>o.name===e);n!==-1?he("Overwrite Template?",`A template named "${e}" already exists. Do you want to overwrite it?`,"Overwrite",()=>{l[n]=t,localStorage.setItem(U,JSON.stringify(l)),D(),i("success","Template updated successfully.")},()=>{}):(l.push(t),localStorage.setItem(U,JSON.stringify(l)),D(),i("success","Template saved successfully.")),d()}function Xe(){const e=f.value;if(!e){i("info","Please select a template to delete.");return}he("Confirm Deletion",`Are you sure you want to delete the template "${e}"? This action cannot be undone.`,"Delete",()=>{l=l.filter(t=>t.name!==e),localStorage.setItem(U,JSON.stringify(l)),H(),D(),i("success","Template deleted successfully.")},()=>{}),d()}function D(){if(f.innerHTML='<option value="">-- Select a template --</option>',l.length===0){f.innerHTML='<option value="">-- No templates available --</option>';return}l.forEach(e=>{const t=document.createElement("option");t.value=e.name,t.textContent=e.name,f.appendChild(t)})}function et(){if(l.length===0){i("info","There are no saved templates to export.");return}const e=JSON.stringify(l,null,2),t=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download=`invoice-templates-backup-${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),i("success","All templates exported successfully.")}function tt(){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=t=>{const n=t.target.files[0];if(!n)return;const o=new FileReader;o.onload=a=>{try{const u=JSON.parse(a.target.result);if(!Array.isArray(u))throw new Error("Invalid JSON format. Expected an array of templates.");let r=0,s=0;u.forEach(c=>{if(!c.name)return;const m=l.findIndex(v=>v.name===c.name);m!==-1?(l[m]=c,s++):(l.push(c),r++)}),localStorage.setItem(U,JSON.stringify(l)),D(),i("success",`Successfully imported ${r} new templates and updated ${s} existing templates.`)}catch(u){i("error","Failed to import configurations: "+u.message)}},o.readAsText(n)},e.click()}function Ee(e){const t=ke(e);if(t.length===0){g.length===0&&i("error","Please select valid PDF file(s)."),b();return}t.forEach(n=>{g.some(o=>o.name===n.name&&o.size===n.size)||g.push(n)}),Z(),K()}function nt(e){g=$e(g,e);const t=new DataTransfer;g.forEach(n=>t.items.add(n)),le.files=t.files,Z(),g.length===0&&(K(),Pe())}async function Be(e){if(!e||e.type!=="application/pdf"){z.value="",p="",re.textContent="",d();return}re.textContent="( "+e.name+" )";const t=new FileReader;t.onload=async n=>{const o=new Uint8Array(n.target.result);try{const u=await(await be()).getDocument({data:o}).promise;let r="";for(let s=1;s<=u.numPages;s++){const m=await(await u.getPage(s)).getTextContent();r+=m.items.map(v=>v.str).join(" ")+`
`}p=r,z.value=r}catch(a){z.value="",i("error","Error extracting text from PDF: "+a.message),p=""}finally{d()}},t.readAsArrayBuffer(e)}function Te(){const e=f.value;if(e===""){H();return}const t=l.find(n=>n.name===e);t?(x=t,J.value=x.name||"",Y.value=x.officialSupplierNameForExport||"",O.value=x.supplierNamePattern||"",B.value=x.documentDatePattern||"",T.value=x.documentNumberPattern||"",P.value=x.totalAmountPattern||""):(i("error","Selected template not found in local storage."),x=null),d(),b()}function ot(e){if(e.target.name==="regexSuggestion"&&e.target.checked){const t=decodeURIComponent(e.target.value);_e(t),A.disabled=!1}}function Z(){pe.innerHTML="",g.length===0?(ve.classList.add("hidden"),ye.classList.remove("hidden"),K()):(ve.classList.remove("hidden"),ye.classList.add("hidden"),g.forEach((e,t)=>{const n=document.createElement("span");n.className="badge badge-md badge-info mr-2 mb-2",n.innerHTML=`
        ${e.name}
        <button type="button" class="ml-2" data-index="${t}">
          <svg class="h-3 w-3" stroke="currentColor" fill="none" viewBox="0 0 8 8">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M1 1l6 6m0-6L1 7" />
          </svg>
        </button>
      `,n.querySelector("button").addEventListener("click",o=>{const a=parseInt(o.currentTarget.dataset.index);nt(a)}),pe.appendChild(n)}),K()),b()}function at(e,t){const n=j,o=n.querySelector('tr td[colspan="7"]');o&&o.parentElement.remove();const a=n.insertRow();a.setAttribute("data-index",t),a.className="table-row-base",a.innerHTML=`
      <td class="text-sm break-words max-w-[150px] overflow-hidden">${e.fileName}</td>
      <td class="text-xs">${e.configUsedName||"-"}</td>
      <td class="text-sm">${e.officialSupplierNameForExport||e.extractedSupplierName||"-"}</td>
      <td class="text-sm">${$(e.documentDate)}</td>
      <td class="text-sm">${e.documentNumber||"-"}</td>
      <td class="text-sm">${V(e.totalAmount)}</td>
      <td>
          <button data-index="${t}" class="analyze-row-button btn btn-info btn-sm flex items-center justify-center">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
          </button>
      </td>
  `,a.querySelector(".analyze-row-button").addEventListener("click",async u=>{const r=parseInt(u.target.closest("button").dataset.index),s=y[r],c=y[r].originalFile;if(M("Template"),await Be(c),ce.textContent=s.extractedSupplierName||"-",de.textContent=$(s.documentDate),ue.textContent=s.documentNumber||"-",me.textContent=V(s.totalAmount),s.configUsedName&&s.configUsedName!=="-"){const m=l.find(v=>v.name===s.configUsedName);m?(f.value=m.name,Te()):(f.value="",x=null,H())}else f.value="",x=null,H();d()})}function st(){j.innerHTML="",y.length===0?j.innerHTML='<tr><td colspan="7" class="text-center">No documents processed yet.</td></tr>':y.forEach((e,t)=>{at(e,t)})}function rt(){if(y.length===0){i("info","No data to export to CSV.");return}const e=["Supplier Name","Document Date","Document Number","Total Amount"],t=y.map(n=>{const o=$(n.documentDate),a=V(n.totalAmount)||"";return{"Supplier Name":n.officialSupplierNameForExport||n.extractedSupplierName,"Document Date":o,"Document Number":n.documentNumber,"Total Amount":a}});Me(t,e,"invoices.csv")}function H(){J.value="",Y.value="",O.value="",B.value="",T.value="",P.value="",x=null,f.value="",d()}function Pe(){ce.textContent="-",de.textContent="-",ue.textContent="-",me.textContent="-",p="",z.value="",re.textContent="",d()}function Ae(){y=[],j.innerHTML='<tr><td colspan="7" class="text-center">No documents processed yet.</td></tr>',b()}function it(){g=[],le.value="",Z(),p="",Pe(),H(),D(),Fe(),Ae(),M("Process"),d(),b(),ne.textContent="Process",oe.classList.add("hidden"),ae.textContent="Preview",se.classList.add("hidden")}function b(){const e=g.length>0,t=y.length>0;te.disabled=!e,Ne.disabled=!t}function d(){const e=p.length>0,t=J.value.trim().length>0,n=f.value!=="";W.disabled=!e,Se.disabled=!t,Ce.disabled=!n,document.querySelectorAll(".ai-suggest-button").forEach(o=>{o.disabled=!e})}function M(e){e==="Process"?(k.classList.add("tab-active"),k.classList.remove("tab-button-inactive"),F.classList.add("tab-button-inactive"),F.classList.remove("tab-active"),fe.classList.remove("hidden"),xe.classList.add("hidden"),b()):e==="Template"&&(F.classList.add("tab-active"),F.classList.remove("tab-button-inactive"),k.classList.add("tab-button-inactive"),k.classList.remove("tab-active"),xe.classList.remove("hidden"),fe.classList.add("hidden"),!p&&g.length>0&&Be(g[0]),d())}document.addEventListener("DOMContentLoaded",async()=>{M("Process"),Z(),d(),b(),Ze(),k.addEventListener("click",()=>M("Process")),F.addEventListener("click",()=>M("Template")),le.addEventListener("change",e=>Ee(e.target.files)),je.addEventListener("click",it),L.addEventListener("dragover",e=>{e.preventDefault(),L.classList.add("border-primary","bg-primary","bg-opacity-10")}),L.addEventListener("dragleave",()=>{L.classList.remove("border-primary","bg-primary","bg-opacity-10")}),L.addEventListener("drop",e=>{e.preventDefault(),L.classList.remove("border-primary","bg-primary","bg-opacity-10"),Ee(e.dataTransfer.files)}),te.addEventListener("click",async()=>{if(g.length===0){ee();return}Ae(),j.innerHTML='<tr><td colspan="7" class="text-center">Processing</td></tr>',b(),ne.textContent="Processing",oe.classList.remove("hidden"),te.disabled=!0;let e=0,t=0,n=0;for(let o=0;o<g.length;o++){const a=g[o];if(a.type!=="application/pdf")continue;const u=new FileReader,r=new Promise((s,c)=>{u.onload=async m=>{const v=new Uint8Array(m.target.result);try{const G=await(await be()).getDocument({data:v}).promise;let w="";for(let C=1;C<=G.numPages;C++){const Q=await(await G.getPage(C)).getTextContent();w+=Q.items.map(De=>De.str).join(" ")+`
`}s(w)}catch(R){c(`Error extracting text from PDF "${a.name}": ${R.message}`)}},u.onerror=m=>c(`FileReader error for "${a.name}": ${m}`),u.readAsArrayBuffer(a)});try{const s=await r;let c,m="-",v=null,R=null;if(l.length>0){const w=Re(s,l);if(w&&w.matchedConfigName&&w.matchedConfigName!=="None"){const C=w.matchedConfigName,q=l.find(Q=>Q.name===C);q&&(v=q,m=C,R=q.officialSupplierNameForExport||null)}}c=ge(s,v);const G={originalFile:a,fileName:a.name,configUsedName:m,extractedSupplierName:c.supplierName||"-",officialSupplierNameForExport:R,documentDate:c.documentDate?$(c.documentDate):"-",documentNumber:c.documentNumber||"-",totalAmount:c.totalAmount||null};y.push(G),m!=="None"&&m!=="-"?t++:n++}catch(s){const c={originalFile:a,fileName:a.name,configUsedName:"Error",extractedSupplierName:"Error",officialSupplierNameForExport:"Error",documentDate:"Error",documentNumber:"Error",totalAmount:null,error:s.message};y.push(c),i("error",`Error processing file "${a.name}": ${s.message}`),n++}e++}y.sort((o,a)=>{const u=new Date(o.documentDate.split("/").reverse().join("-")),r=new Date(a.documentDate.split("/").reverse().join("-"));return isNaN(u.getTime())&&isNaN(r.getTime())?0:isNaN(u.getTime())?1:isNaN(r.getTime())?-1:u.getTime()-r.getTime()}),st(),e>0?(t>0&&i("success",`${t} PDF(s) extracted successfully. Data ready for download.`),n>0&&i("warning",`${n} PDF(s) failed to extract.`)):i("warning","No PDFs were processed."),ne.textContent="Process",oe.classList.add("hidden"),b()}),W.addEventListener("click",async()=>{if(!p){ee();return}ae.textContent="Previewing",se.classList.remove("hidden"),W.disabled=!0;try{const e={supplierNamePattern:O.value,documentDatePattern:B.value,documentNumberPattern:T.value,totalAmountPattern:P.value},t=ge(p,e);t?(ce.textContent=t.supplierName||"-",de.textContent=$(t.documentDate),ue.textContent=t.documentNumber||"-",me.textContent=V(t.totalAmount),i("success","Preview complete!")):i("warning","No refined data extracted during preview.")}catch(e){i("error",`Error during preview: ${e.message}. Check console for details.`)}finally{ae.textContent="Preview",se.classList.add("hidden"),d(),b()}}),Ue.addEventListener("click",async()=>{await X("documentDate")}),He.addEventListener("click",async()=>{await X("documentNumber")}),Je.addEventListener("click",async()=>{await X("totalAmount")}),I.addEventListener("click",Ye),qe.addEventListener("click",Le),A.addEventListener("click",Ve),Se.addEventListener("click",Qe),Ce.addEventListener("click",Xe),ze.addEventListener("click",tt),Ke.addEventListener("click",et),f.addEventListener("change",Te),Ne.addEventListener("click",rt),f.addEventListener("change",()=>{d()}),J.addEventListener("input",d),Y.addEventListener("input",d),O.addEventListener("input",d),B.addEventListener("input",d),T.addEventListener("input",d),P.addEventListener("input",d)});
